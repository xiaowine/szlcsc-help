class CouponApp{constructor(){this.data=null,this.categories=null,this.brandCount=0,this.modal=null,this.categoryContainer=null}async init(){try{await this.loadRunTime(),await this.loadCouponData(),this.setupEventListeners(),this.initializeComponents()}catch(e){console.error("初始化失败:",e),document.getElementById("loading").innerHTML="<p>数据加载失败，请稍后重试</p>"}}async loadRunTime(){const e=await fetch("run_time.txt"),t=await e.text();document.getElementById("run_time").textContent=`更新时间：${t}`}async loadCouponData(){const e=await fetch("coupon_details.json");this.data=await e.json(),this.categories=Object.keys(this.data),this.brandCount=Object.values(this.data).flat().length,document.getElementById("loading").style.display="none",document.getElementById("count").textContent=`品牌数：${this.brandCount}，分类数：${this.categories.length}`}setupEventListeners(){this.setupModalEvents(),this.setupBackToTopButton(),this.setupSearchFeature()}setupModalEvents(){const e=document.getElementById("infoModal"),t=document.getElementById("showInfo"),n=document.getElementById("closeModal");t?.addEventListener("click",(()=>e.style.display="flex")),n?.addEventListener("click",(()=>e.style.display="none")),e?.addEventListener("click",(t=>{t.target===e&&(e.style.display="none")}))}setupBackToTopButton(){const e=document.getElementById("backToTop"),t=document.querySelector(".container");t?.addEventListener("scroll",(()=>{e.style.display=t.scrollTop>300?"flex":"none"})),e?.addEventListener("click",(()=>{t.scrollTo({top:0,behavior:"smooth"})}))}filterCategories(e){const t=document.querySelectorAll(".category-nav a");e?(this.categoryContainer.classList.contains("category_active")||this.categoryContainer.classList.add("category_active"),t.forEach((t=>{t.textContent.toLowerCase().includes(e)?t.style.display="block":t.style.display="none"}))):t.forEach((e=>e.style.display="block"))}setupSearchFeature(){const e=document.getElementById("searchToggle"),t=document.getElementById("searchClose"),n=document.querySelector(".search-container"),a=document.getElementById("categorySearch"),o=()=>{n.classList.remove("active_search"),setTimeout((()=>n.style.display="none"),300),a.value="",this.filterCategories(""),a.blur()};e?.addEventListener("click",(e=>{e.preventDefault(),n.classList.contains("active_search")?o():(n.style.display="flex",n.offsetHeight,n.classList.add("active_search"),setTimeout((()=>a.focus()),300))})),t?.addEventListener("click",(e=>{e.preventDefault(),o()})),a?.addEventListener("input",(e=>{this.filterCategories(e.target.value.trim().toLowerCase())})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&(n.classList.contains("active_search")&&o(),"flex"===this.modal?.style.display&&(this.modal.style.display="none"))}))}initializeComponents(){this.initializeCategoryNav(),this.initializeCouponGrid()}initializeCategoryNav(){const e=document.getElementById("category-nav");this.categoryContainer=this.createCategoryContainer(),e.appendChild(this.categoryContainer)}createCategoryContainer(){const e=document.createElement("div");e.className="category-container";const t=document.createElement("div");t.className="category-header",t.innerHTML=`\n            <h2>\n                分类列表\n                <span class="category-count">(${this.categories.length}个分类)</span>\n            </h2>\n            <i class="fas fa-chevron-down toggle-icon"></i>\n        `;const n=document.createElement("div");n.className="category-content";const a=this.createCategoryNav();return n.appendChild(a),e.appendChild(t),e.appendChild(n),t.addEventListener("click",(()=>{e.classList.toggle("category_active")})),e}createCategoryNav(){const e=document.createElement("div");return e.className="category-nav",this.categories.forEach((t=>{const n=document.createElement("a");n.href=`#${t}`,n.innerHTML=`${t} <small>(${this.data[t].length})</small>`,n.addEventListener("click",(e=>this.handleCategoryClick(e,t))),e.appendChild(n)})),e}handleCategoryClick(e,t){e.preventDefault(),this.categoryContainer.classList.remove("category_active");const n=document.getElementById(t);n.scrollIntoView({behavior:"smooth",block:"center"}),n.classList.add("highlight"),document.querySelectorAll(".category-card.highlight").forEach((e=>{e!==n&&e.classList.remove("highlight")}))}initializeCouponGrid(){const e=document.getElementById("coupon-grid");this.modal=document.createElement("div"),this.modal.className="coupon-modal",document.body.appendChild(this.modal);this.getSortedCategories().forEach((t=>this.createCategoryCard(t,e)))}getSortedCategories(){return this.categories.sort(((e,t)=>{const n=this.getAverageReceiveNum(this.data[e]);return this.getAverageReceiveNum(this.data[t])-n}))}getAverageReceiveNum(e){return e.reduce(((e,t)=>e+t.receive_customer_num),0)/e.length}createCategoryCard(e,t){const n=document.createElement("div");n.className="category-card",n.id=e;const a=this.getAverageReceiveNum(this.data[e]);n.innerHTML=`\n            <h2>${e} <br>\n                <span class="brand-count">\n                    共${this.data[e].length}个品牌<br>\n                    平均领取数: ${a.toFixed(0)}\n                </span>\n            </h2>\n        `,n.addEventListener("click",(()=>this.showCouponModal(e,a))),t.appendChild(n)}showCouponModal(e,t){const n=this.data[e].sort(((e,t)=>t.receive_customer_num-e.receive_customer_num));this.modal.innerHTML=this.createModalContent(e,t,n),this.modal.style.display="flex";this.modal.querySelector(".coupon-modal-close").addEventListener("click",(()=>this.modal.style.display="none")),this.modal.addEventListener("click",(e=>{e.target===this.modal&&(this.modal.style.display="none")}))}createModalContent(e,t,n){return`\n            <div class="coupon-modal-content">\n                <div class="coupon-modal-header">\n                    <h2>${e}</h2>平均领取数: ${t.toFixed(0)}\n                    <button class="coupon-modal-close">&times;</button>\n                </div>\n                <div class="coupon-modal-body">\n                    <ul class="coupon-list">\n                        ${n.map((e=>`\n                            <li class="coupon-item">\n                                <a href="https://list.szlcsc.com/brand/${e.brand_id}.html" target="_blank">\n                                    ${e.brand_name} - ${e.coupon_name}\n                                    <small>(优惠后最低消费${e.min_order_after_discount}元)</small>\n                                    <small>- 已领取${e.receive_customer_num}张</small>\n                                </a>\n                            </li>\n                        `)).join("")}\n                    </ul>\n                </div>\n            </div>\n        `}}document.addEventListener("DOMContentLoaded",(()=>{(new CouponApp).init()}));